# {{- $useExisitingVolume := and .Values.existingVolumes.enabled (ne .Values.existingVolumes.data "") }}
# {{- if $useExisitingVolume -}}
# kind: StorageClass
# apiVersion: storage.k8s.io/v1
# metadata:
#   name: "sc-{{ include "..fullname" . }}-data"
#   annotations:
#     "helm.sh/hook": "pre-install"
# provisioner: efs.csi.aws.com
# parameters:
#   type: gp2
# reclaimPolicy: Retain
# mountOptions:
#   - debug
# volumeBindingMode: Immediate
# ---
# apiVersion: v1
# kind: PersistentVolume
# metadata:
#   name: "pv-{{ include "..fullname" . }}-data"
#   labels:
#     type: amazonEBS
#   annotations:
#     "helm.sh/hook": "pre-install"
# spec:
#   capacity:
#     storage: 10Gi
#   accessModes:
#     - ReadWriteOnce
#   volumeMode: Filesystem
#   storageClassName: "sc-{{ include "..fullname" . }}-data"
#   csi:  
#     driver: efs.csi.aws.com
#     volumeHandle: fs-8e4b7563
# ---
# {{- end -}}
# apiVersion: v1
# kind: PersistentVolumeClaim
# metadata:
#   name: "pvc-{{ include "..fullname" . }}-data"
#   annotations:
#     "helm.sh/hook": "pre-install"
# spec:
#   {{- if $useExisitingVolume }}
#   storageClassName: "sc-{{ include "..fullname" . }}-data"
#   {{- end }}
#   accessModes:
#     - ReadWriteOnce
#   resources:
#     requests:
#       storage: 10Gi

kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: "efs-sc-{{ include "..fullname" . }}-data"
  annotations:
    "helm.sh/hook": "pre-install"
provisioner: efs.csi.aws.com
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: "efs-claim-{{ include "..fullname" . }}-data"
  annotations:
    "helm.sh/hook": "pre-install"
spec:
  # {{- if $useExisitingVolume }}
  # storageClassName: "sc-{{ include "..fullname" . }}-data"
  # {{- end }}
  accessModes:
    - ReadWriteMany
  storageClassName: "efs-sc-{{ include "..fullname" . }}-data"
  resources:
    requests:
      storage: 5Gi
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: efs-pv-{{ include "..fullname" . }}-data
  annotations:
    "helm.sh/hook": "pre-install"
spec:
  capacity:
    storage: 5Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: efs-sc-{{ include "..fullname" . }}-data
  csi:
    driver: efs.csi.aws.com
    volumeHandle: fs-0fedd3e2